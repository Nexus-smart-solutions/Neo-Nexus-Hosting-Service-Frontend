name: Nexus CI/CD & Audit Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Important for git diff to see history

      - name: Start Performance Timer
        run: echo "START_TIME=$(date +%s)" >> $GITHUB_ENV

      # --- Put your build/test steps here ---
      - name: Run Build/Test
        run: |
          echo "Simulating Build Process..."
          sleep 5 # Simulated delay to see duration
      # ---------------------------------------

      - name: Generate Nexus Audit Report
        if: always() # Runs even if previous steps fail
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "### ðŸš€ Nexus DevOps Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“Š Execution Metrics" >> $GITHUB_STEP_SUMMARY
          echo "* **Commit Message:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "* **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "* **Action Status:** ${{ job.status }} âœ…" >> $GITHUB_STEP_SUMMARY
          echo "* **Total Duration:** ${DURATION} seconds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### ðŸ“„ File Changes Audit" >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          # List changed files compared to the previous commit
          git diff --name-status HEAD~1 HEAD >> $GITHUB_STEP_SUMMARY || echo "No previous commit for diff" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Finalize Audit Trace
        run: echo "Audit for commit ${{ github.sha }} completed."
